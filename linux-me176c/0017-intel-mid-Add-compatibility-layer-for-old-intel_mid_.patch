From 52bb13d233f7991929dd9bf79431b8e19687bb59 Mon Sep 17 00:00:00 2001
From: lambdadroid <lambdadroid@gmail.com>
Date: Tue, 23 May 2017 21:47:10 +0200
Subject: [PATCH 17/19] intel-mid: Add compatibility layer for old
 intel_mid_pmic.h

---
 drivers/mfd/Kconfig                |  4 ++++
 drivers/mfd/Makefile               |  1 +
 drivers/mfd/intel_mid_pmic.c       | 45 ++++++++++++++++++++++++++++++++++++++
 drivers/mfd/intel_soc_pmic_core.c  | 14 ++++++++++++
 include/linux/mfd/intel_mid_pmic.h | 10 +++++++++
 5 files changed, 74 insertions(+)
 create mode 100644 drivers/mfd/intel_mid_pmic.c
 create mode 100644 include/linux/mfd/intel_mid_pmic.h

diff --git a/drivers/mfd/Kconfig b/drivers/mfd/Kconfig
index fc5e4fef89d2..95226b113406 100644
--- a/drivers/mfd/Kconfig
+++ b/drivers/mfd/Kconfig
@@ -483,6 +483,10 @@ config INTEL_SOC_PMIC
 	  available before any devices using it are probed. This option also
 	  causes the designware-i2c driver to be builtin for the same reason.
 
+config INTEL_MID_PMIC_COMPAT
+	bool "Intel MID PMIC Compatibility Interface"
+	depends on INTEL_SOC_PMIC
+
 config INTEL_SOC_PMIC_BXTWC
 	tristate "Support for Intel Broxton Whiskey Cove PMIC"
 	depends on INTEL_PMC_IPC
diff --git a/drivers/mfd/Makefile b/drivers/mfd/Makefile
index 8703ff17998e..930edc06184e 100644
--- a/drivers/mfd/Makefile
+++ b/drivers/mfd/Makefile
@@ -217,6 +217,7 @@ obj-$(CONFIG_MFD_SKY81452)	+= sky81452.o
 
 intel-soc-pmic-objs		:= intel_soc_pmic_core.o intel_soc_pmic_crc.o
 obj-$(CONFIG_INTEL_SOC_PMIC)	+= intel-soc-pmic.o
+obj-$(CONFIG_INTEL_MID_PMIC_COMPAT) += intel_mid_pmic.o
 obj-$(CONFIG_INTEL_SOC_PMIC_BXTWC)	+= intel_soc_pmic_bxtwc.o
 obj-$(CONFIG_INTEL_SOC_PMIC_CHTWC)	+= intel_soc_pmic_chtwc.o
 obj-$(CONFIG_MFD_MT6397)	+= mt6397-core.o
diff --git a/drivers/mfd/intel_mid_pmic.c b/drivers/mfd/intel_mid_pmic.c
new file mode 100644
index 000000000000..f3bc2e20b5a4
--- /dev/null
+++ b/drivers/mfd/intel_mid_pmic.c
@@ -0,0 +1,45 @@
+#include <linux/mfd/intel_soc_pmic.h>
+#include <linux/mfd/intel_mid_pmic.h>
+
+extern struct intel_soc_pmic *intel_pmic;
+
+int intel_mid_pmic_readb(int reg)
+{
+	int ret;
+	unsigned int result;
+
+	if (!intel_pmic)
+		return -EIO;
+
+	ret = regmap_read(intel_pmic->regmap, reg, &result);
+	if (ret)
+		return ret;
+
+	return result;
+}
+
+int intel_mid_pmic_writeb(int reg, u8 val)
+{
+	if (!intel_pmic)
+		return -EIO;
+
+	return regmap_write(intel_pmic->regmap, reg, val);
+}
+
+int intel_mid_pmic_setb(int reg, u8 mask)
+{
+	if (!intel_pmic)
+		return -EIO;
+
+	// ((val & ~mask) | (mask & mask)) == (val | mask)
+	return regmap_update_bits(intel_pmic->regmap, reg, mask, mask);
+}
+
+int intel_mid_pmic_clearb(int reg, u8 mask)
+{
+	if (!intel_pmic)
+		return -EIO;
+
+	// ((val & ~mask) | (0 & mask)) == (val & ~mask)
+	return regmap_update_bits(intel_pmic->regmap, reg, mask, 0);
+}
diff --git a/drivers/mfd/intel_soc_pmic_core.c b/drivers/mfd/intel_soc_pmic_core.c
index 36adf9e8153e..d358c9dbd836 100644
--- a/drivers/mfd/intel_soc_pmic_core.c
+++ b/drivers/mfd/intel_soc_pmic_core.c
@@ -33,6 +33,12 @@
 #define BYT_CRC_HRV		2
 #define CHT_CRC_HRV		3
 
+#ifdef CONFIG_INTEL_MID_PMIC_COMPAT
+// Global instance of PMIC for Intel MID compatibility
+// TODO: Figure out better solution to access it from various drivers
+struct intel_soc_pmic *intel_pmic = NULL;
+#endif
+
 /* Lookup table for the Panel Enable/Disable line as GPIO signals */
 static struct gpiod_lookup_table panel_gpio_table = {
 	/* Intel GFX is consumer */
@@ -110,6 +116,10 @@ static int intel_soc_pmic_i2c_probe(struct i2c_client *i2c,
 	/* Add lookup table for crc-pwm */
 	pwm_add_table(crc_pwm_lookup, ARRAY_SIZE(crc_pwm_lookup));
 
+#ifdef CONFIG_INTEL_MID_PMIC_COMPAT
+	intel_pmic = pmic;
+#endif
+
 	ret = mfd_add_devices(dev, -1, config->cell_dev,
 			      config->n_cell_devs, NULL, 0,
 			      regmap_irq_get_domain(pmic->irq_chip_data));
@@ -137,6 +147,10 @@ static int intel_soc_pmic_i2c_remove(struct i2c_client *i2c)
 
 	mfd_remove_devices(&i2c->dev);
 
+#ifdef CONFIG_INTEL_MID_PMIC_COMPAT
+	intel_pmic = NULL;
+#endif
+
 	return 0;
 }
 
diff --git a/include/linux/mfd/intel_mid_pmic.h b/include/linux/mfd/intel_mid_pmic.h
new file mode 100644
index 000000000000..fbdd566dd836
--- /dev/null
+++ b/include/linux/mfd/intel_mid_pmic.h
@@ -0,0 +1,10 @@
+#ifndef __INTEL_MID_PMIC_H__
+#define __INTEL_MID_PMIC_H__
+
+int intel_mid_pmic_readb(int reg);
+int intel_mid_pmic_writeb(int reg, u8 val);
+
+int intel_mid_pmic_setb(int reg, u8 mask);
+int intel_mid_pmic_clearb(int reg, u8 mask);
+
+#endif
-- 
2.15.1

